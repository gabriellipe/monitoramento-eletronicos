<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MVP – Painel (Gestor)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:1100px}
    h1{font-size:1.4rem}
    .muted{color:#666}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tabbtn{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#f7f7f7;cursor:pointer}
    .tabbtn.active{background:#e9f0ff;border-color:#98b2ff}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:8px 0 4px}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:8px}
    input,select{width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:.95rem}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef;margin-right:6px;font-size:.8rem}
    .actions{display:flex;gap:10px;align-items:center;margin:10px 0}
  </style>
</head>
<body>
  <h1>MVP – Painel (Gestor)</h1>
  <div class="actions">
    <button id="login">Entrar com Google</button>
    <button id="logout" style="display:none">Sair</button>
    <span id="who" class="muted"></span>
  </div>

  <div class="tabs">
    <button class="tabbtn active" data-tab="oc">Ocorrências</button>
    <button class="tabbtn" data-tab="pp">Pessoas & Papéis</button>
  </div>

  <!-- Aba Ocorrências -->
  <div id="tab-oc" class="tab card">
    <div class="muted">Atualiza automaticamente (Realtime). É necessário ser <b>manager</b>.</div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Data/Hora</th><th>Turma</th><th>Professor</th><th>Aluno</th>
          <th>Ocorrência</th><th>Passo</th><th>Sinais</th><th>Obs.</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Aba Pessoas & Papéis -->
  <div id="tab-pp" class="tab card" style="display:none">
    <h3>Adicionar/Atualizar Papel por E-mail</h3>
    <div class="row">
      <div>
        <label>E-mail</label>
        <input id="pp_email" placeholder="prof@escola.pe.gov.br">
      </div>
      <div>
        <label>Papel</label>
        <select id="pp_papel">
          <option value="teacher">Professor(a)</option>
          <option value="manager">Gestor(a)</option>
        </select>
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="pp_salvar">Salvar papel</button>
    </div>

    <h3 style="margin-top:24px">Vincular Turma por E-mail</h3>
    <div class="row">
      <div>
        <label>E-mail</label>
        <input id="vt_email" placeholder="prof@escola.pe.gov.br">
      </div>
      <div>
        <label>Turma</label>
        <input id="vt_turma" placeholder="Ex.: 8ºA">
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="vt_vincular">Vincular turma</button>
    </div>

    <h3 style="margin-top:24px">Lista de Perfis</h3>
    <table id="tblPerfis">
      <thead>
        <tr><th>E-mail</th><th>Papel</th><th>User ID</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3 style="margin-top:24px">Vinculações (turmas_prof)</h3>
    <table id="tblTurmas">
      <thead>
        <tr><th>E-mail</th><th>Turma</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://wzzryluesqxwyijievyj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6enJ5bHVlc3F4d3lpamlldnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTk2NjYsImV4cCI6MjA3NDU3NTY2Nn0.aqT7PaKjj9QS547HEQ7EDyl8kvCIg4GrQJ4AXvjsG0k";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const who = document.getElementById("who");
    const tbody = document.querySelector("#tbl tbody");
    const tbodyPerfis = document.querySelector("#tblPerfis tbody");
    const tbodyTurmas = document.querySelector("#tblTurmas tbody");
    let channel = null;

    // Tabs
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.onclick = ()=>{
        document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
        document.getElementById("tab-"+btn.dataset.tab).style.display="block";
      };
    });

    // Login / Logout
    document.getElementById("login").onclick = async ()=>{
      const here = location.href.split('#')[0].split('?')[0];
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: here }
      });
      if (error) alert("Falha no login Google: " + error.message);
    };
    document.getElementById("logout").onclick = async ()=>{
      if (channel) { await supabase.removeChannel(channel); channel = null; }
      await supabase.auth.signOut();
      location.reload();
    };

    function renderOcorrencias(rows){
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${new Date(r.created_at).toLocaleString('pt-BR')}</td>
          <td>${r.turma||''}</td>
          <td>${r.professor||''}</td>
          <td>${r.aluno_codigo||''}</td>
          <td>${r.ocorrencia||''}</td>
          <td>${r.passo_protocolo||''}</td>
          <td>${(r.sinais||[]).map(s=>`<span class="pill">${s}</span>`).join('')}</td>
          <td>${(r.observacoes||'').substring(0,120)}</td>
        </tr>
      `).join("");
    }

    async function ensureManager(){
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session) return false;
      who.textContent = "Logado: " + (session.user.email || session.user.id);
      document.getElementById("login").style.display = "none";
      document.getElementById("logout").style.display = "inline-block";

      const { data: perfil, error } = await supabase
        .from("perfis").select("papel").eq("user_id", session.user.id).maybeSingle();
      if (error) { alert("Erro ao verificar papel: " + error.message); return false; }
      if (!perfil || perfil.papel !== "manager"){
        alert("Acesso negado. É necessário papel MANAGER.");
        return false;
      }
      return true;
    }

    async function loadOcorrencias(){
      const ok = await ensureManager(); if(!ok) return;
      const { data, error } = await supabase
        .from("ocorrencias")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(50);
      if (error){ console.error(error); alert("Falha ao carregar ocorrências."); return; }
      renderOcorrencias(data || []);

      if (channel) { await supabase.removeChannel(channel); channel = null; }
      channel = supabase
        .channel('ocorrencias_rt')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ocorrencias' }, payload => {
          const row = payload.new;
          if (!row) return;
          const current = Array.from(tbody.querySelectorAll("tr")).map(tr => tr.innerHTML);
          tbody.insertAdjacentHTML('afterbegin', `
            <tr>
              <td>${new Date(row.created_at).toLocaleString('pt-BR')}</td>
              <td>${row.turma||''}</td>
              <td>${row.professor||''}</td>
              <td>${row.aluno_codigo||''}</td>
              <td>${row.ocorrencia||''}</td>
              <td>${row.passo_protocolo||''}</td>
              <td>${(row.sinais||[]).map(s=>`<span class="pill">${s}</span>`).join('')}</td>
              <td>${(row.observacoes||'').substring(0,120)}</td>
            </tr>
          `);
        })
        .subscribe();
    }

    async function loadPerfisETurmas(){
      const ok = await ensureManager(); if(!ok) return;

      // Perfis
      const { data: perfis, error: e1 } = await supabase
        .from("perfis").select("email,papel,user_id").order("papel, email");
      if (e1){ console.error(e1); alert("Falha ao carregar perfis."); return; }
      tbodyPerfis.innerHTML = (perfis||[]).map(p=>`
        <tr><td>${p.email||''}</td><td>${p.papel}</td><td>${p.user_id}</td></tr>
      `).join("");

      // Vinculações
      // Vamos juntar com emails via subquery para ficar legível
      const { data: vincs, error: e2 } = await supabase
        .from("turmas_prof")
        .select("user_id,turma");
      if (e2){ console.error(e2); alert("Falha ao carregar turmas."); return; }

      const mapEmail = Object.fromEntries((perfis||[]).map(p=>[p.user_id, p.email]));
      tbodyTurmas.innerHTML = (vincs||[]).map(v=>`
        <tr><td>${mapEmail[v.user_id]||v.user_id}</td><td>${v.turma}</td></tr>
      `).join("");
    }

    // Ações da aba Pessoas & Papéis
    document.getElementById("pp_salvar").onclick = async ()=>{
      const email = document.getElementById("pp_email").value.trim();
      const papel = document.getElementById("pp_papel").value;
      if (!email) { alert("Informe o e-mail."); return; }

      // Chama a RPC segura (faz o lookup em auth.users e upsert em perfis)
      const { error } = await supabase.rpc("add_or_update_profile", { p_email: email, p_papel: papel });
      if (error){ alert("Erro ao salvar papel: " + error.message); return; }
      alert("Papel salvo!");
      loadPerfisETurmas();
    };

    document.getElementById("vt_vincular").onclick = async ()=>{
      const email = document.getElementById("vt_email").value.trim();
      const turma = document.getElementById("vt_turma").value.trim();
      if (!email || !turma) { alert("Informe e-mail e turma."); return; }

      const { error } = await supabase.rpc("link_turma", { p_email: email, p_turma: turma });
      if (error){ alert("Erro ao vincular turma: " + error.message); return; }
      alert("Turma vinculada!");
      loadPerfisETurmas();
    };

    // Boot
    async function boot(){
      const { data:{ session } } = await supabase.auth.getSession();
      const logged = !!session;
      document.getElementById("login").style.display  = logged ? "none" : "inline-block";
      document.getElementById("logout").style.display = logged ? "inline-block" : "none";
      who.textContent = logged ? ("Logado: " + (session.user.email || session.user.id)) : "";

      if (logged){
        await loadOcorrencias();
        await loadPerfisETurmas();
      }
    }
    boot();
    supabase.auth.onAuthStateChange(()=>boot());
  </script>
</body>
</html>

