<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Ocorrência — Professor (Google)</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:760px}
    h1{font-size:1.4rem;margin-bottom:8px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:16px}
    label{display:block;margin:8px 0 4px}
    input,select,textarea,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
    textarea{min-height:100px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#666;font-size:.9rem}
    .ok{background:#e6ffed;border-color:#b7f2c0}
    .err{background:#ffecec;border-color:#ffb3b3}
    .hidden{display:none}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .chip{border:1px solid #ccc;padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none}
    .chip.active{background:#eef;border-color:#99c}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;align-items:center}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef;margin:4px 6px 0 0;font-size:.85rem}
  </style>
</head>
<body>
  <h1>Registro de Ocorrência — Professor</h1>
  <p class="muted">Faça login com Google. Vincule quantas turmas precisar; depois envie ocorrências.</p>

  <div class="actions">
    <button id="login">Entrar com Google</button>
    <button id="logout" class="hidden">Sair</button>
    <span id="who" class="muted"></span>
  </div>

  <!-- Vincular turma (sempre visível) -->
  <div id="vinculo" class="card">
    <h3>Vincular turma</h3>
    <div class="row">
      <div>
        <label>Ano</label>
        <select id="anoSel"></select>
      </div>
      <div>
        <label>Letra</label>
        <select id="letraSel"></select>
      </div>
    </div>
    <button id="btn_vincular" style="margin-top:10px">Vincular</button>
    <p class="muted" style="margin-top:6px">Formato: 4ºA, 4ºB … 9ºD.</p>

    <div id="minhasTurmas" style="margin-top:10px">
      <strong>Suas turmas:</strong>
      <div id="turmasTags" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- Formulário -->
  <div id="form" class="card hidden">
    <div class="row-3">
      <div>
        <label>Turma</label>
        <select id="turma"><option value="">Selecione...</option></select>
      </div>
      <div>
        <label>Professor(a)</label>
        <input id="professor" placeholder="Ex.: M. Souza" maxlength="50" />
      </div>
      <div>
        <label>Aluno (iniciais/código)</label>
        <input id="aluno" placeholder="Ex.: A23" maxlength="50" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Ocorrência</label>
        <select id="ocorrencia">
          <option value="">Selecione...</option>
          <option value="uso_indevido">Uso indevido em sala</option>
          <option value="reincidencia">Reincidência</option>
          <option value="grave">Grave (desrespeito / conflito)</option>
        </select>
      </div>
      <div>
        <label>Passo do Protocolo</label>
        <select id="passo">
          <option value="">Selecione...</option>
          <option value="advertencia">Advertência educativa</option>
          <option value="conscientizacao">Atividade de conscientização</option>
          <option value="recolhimento">Recolhimento (sem exposição)</option>
          <option value="registro">Registro e acompanhamento</option>
          <option value="familia">Envolvimento familiar</option>
          <option value="acompanhamento">Acompanhamento reflexivo</option>
        </select>
      </div>
    </div>

    <label>Sinais observados (opcional)</label>
    <div class="chips" id="sinais">
      <div class="chip" data-key="distracao">Distração</div>
      <div class="chip" data-key="ansiedade">Ansiedade/irritação</div>
      <div class="chip" data-key="isolamento">Isolamento social</div>
      <div class="chip" data-key="queda">Queda no rendimento</div>
      <div class="chip" data-key="sonolencia">Sonolência</div>
    </div>

    <label>Observações (opcional)</label>
    <textarea id="obs" placeholder="Descrição objetiva (máx. 1000)" maxlength="1000"></textarea>

    <button id="enviar">Enviar registro</button>
    <div id="msg" class="card hidden"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // >>> Substitua pelos seus valores
   const SUPABASE_URL = "https://wzzryluesqxwyijievyj.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6enJ5bHVlc3F4d3lpamlldnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5OTk2NjYsImV4cCI6MjA3NDU3NTY2Nn0.aqT7PaKjj9QS547HEQ7EDyl8kvCIg4GrQJ4AXvjsG0k";
    // <<<

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const chips = document.querySelectorAll(".chip");
    chips.forEach(c => c.addEventListener("click", () => c.classList.toggle("active")));
    const getSinais = () => Array.from(document.querySelectorAll(".chip.active")).map(c => c.dataset.key);

    function showMsg(text, ok=true){
      const box = $("msg"); if(!box) return;
      box.className = "card " + (ok ? "ok" : "err");
      box.textContent = text;
      box.classList.remove("hidden");
    }

    // Preenche selects de Ano e Letra
    (function initAnoLetra(){
      const anos = [4,5,6,7,8,9];
      const letras = ['A','B','C','D'];
      $("anoSel").innerHTML   = anos.map(a => `<option value="${a}">${a}º</option>`).join("");
      $("letraSel").innerHTML = letras.map(l => `<option value="${l}">${l}</option>`).join("");
    })();

    // Login/Logout Google
    $("login").onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({
  provider: "google",
  options: { redirectTo: 'https://gabriellipe.github.io/monitoramento-eletronicos/admin_mvp.html' }
});

      if (error) alert("Falha no login Google: " + error.message);
    };
    $("logout").onclick = async () => { await supabase.auth.signOut(); location.reload(); };

    // Vincular turma selecionada (4º–9º / A–D)
    $("btn_vincular").onclick = async () => {
      const ano = $("anoSel").value;
      const letra = $("letraSel").value;
      const turma = `${ano}º${letra}`;
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session){ alert("Faça login primeiro."); return; }

      const { error } = await supabase
        .from("turmas_prof")
        .insert([{ user_id: session.user.id, turma }]);

      if (error) {
        // Trata duplicado de forma amigável
        if (error.code === '23505') {
          alert(`Você já está vinculado à turma ${turma}.`);
        } else {
          alert("Erro ao vincular: " + error.message);
        }
        return;
      }
      await refreshTurmas(session.user.id);
      alert(`Turma ${turma} vinculada!`);
    };

    // Carrega e renderiza turmas do professor (tags + select do formulário)
    async function refreshTurmas(uid){
      const { data, error } = await supabase
        .from("turmas_prof").select("turma").eq("user_id", uid).order("turma");
      if (error){ showMsg("Erro ao carregar turmas: " + error.message, false); return; }

      const list = data || [];
      // Tags
      const tags = list.map(t => `<span class="pill">${t.turma}</span>`).join("") || '<span class="muted">Nenhuma</span>';
      $("turmasTags").innerHTML = tags;

      // Select do formulário
      const sel = $("turma");
      sel.innerHTML = '<option value="">Selecione...</option>' + list.map(t => `<option>${t.turma}</option>`).join("");

      // Exibir formulário se tiver ao menos 1 turma
      const has = list.length > 0;
      $("form").classList.toggle("hidden", !has);
    }

    async function boot(){
      const { data:{ session } } = await supabase.auth.getSession();
      if (!session){
        $("form").classList.add("hidden");
        $("logout").classList.add("hidden");
        $("login").classList.remove("hidden");
        $("who").textContent = "";
        return;
      }
      $("logout").classList.remove("hidden");
      $("login").classList.add("hidden");
      $("who").textContent = "Logado: " + (session.user.email || session.user.id);

      // garante perfil (teacher) na primeira vez; ignora erro de conflito
      await supabase.from("perfis").insert({
        user_id: session.user.id, papel: "teacher", email: session.user.email || ""
      }).select().maybeSingle().catch(()=>{});

      await refreshTurmas(session.user.id);

      $("enviar").onclick = async () => {
        const turma = $("turma").value.trim();
        const professor = $("professor").value.trim();
        const aluno = $("aluno").value.trim();
        const ocorrencia = $("ocorrencia").value;
        const passo = $("passo").value;
        const observacoes = $("obs").value.trim();
        const sinais = getSinais();

        if (!turma || !professor || !aluno || !ocorrencia || !passo){
          showMsg("Preencha Turma, Professor, Aluno, Ocorrência e Passo.", false); return;
        }

        const { error } = await supabase.from("ocorrencias").insert([{
          turma, professor, aluno_codigo: aluno,
          ocorrencia, passo_protocolo: passo, sinais, observacoes,
          created_by: session.user.id
        }]);

        if (error){ showMsg("Falha ao enviar: " + error.message, false); return; }

        $("aluno").value = ""; $("ocorrencia").value = "";
        $("passo").value = ""; $("obs").value = "";
        document.querySelectorAll(".chip.active").forEach(c=>c.classList.remove("active"));
        showMsg("Registro enviado com sucesso!");
      };
    }

    boot();
    supabase.auth.onAuthStateChange(()=>boot());
  </script>
</body>
</html>

